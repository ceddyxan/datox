{% extends "base.html" %}

{% block title %}Shopping Cart - Datox Jars{% endblock %}

{% block content %}
<section class="py-16 bg-gradient-to-br from-gray-50 to-slate-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
            <h1 class="text-4xl font-light text-gray-900 mb-3">Shopping Cart</h1>
            <p class="text-gray-600">{{ cart_items|length }} {{ 'item' if cart_items|length == 1 else 'items' }} in your cart</p>
        </div>
        
        {% if cart_items %}
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
            <!-- Cart Items -->
            {% for item in cart_items %}
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-lg transition-all duration-300">
                <div class="p-4">
                    <!-- Product Image -->
                    <div class="w-full h-32 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl flex items-center justify-center overflow-hidden mb-4">
                        <img src="{{ url_for('static', filename=item.image) }}" alt="{{ item.name }}" class="w-full h-full object-cover">
                    </div>
                    
                    <!-- Product Details -->
                    <div class="space-y-3">
                        <h3 class="text-base font-medium text-gray-900 line-clamp-2">{{ item.name }}</h3>
                        <p class="text-sm text-gray-500">{{ item.category }}</p>
                        <p class="text-lg font-semibold text-amber-600">{{ item.price | currency_format }}</p>
                        
                        <!-- Quantity Controls -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <button onclick="updateQuantity('{{ item.id }}', parseInt('{{ item.quantity }}') - 1)" 
                                        class="w-8 h-8 rounded-full border border-gray-200 flex items-center justify-center hover:bg-gray-50 hover:border-gray-300 transition-all">
                                    <svg class="w-3 h-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                                    </svg>
                                </button>
                                <span class="w-8 text-center font-medium text-gray-900 text-sm">{{ item.quantity }}</span>
                                <button onclick="updateQuantity('{{ item.id }}', parseInt('{{ item.quantity }}') + 1)" 
                                        class="w-8 h-8 rounded-full border border-gray-200 flex items-center justify-center hover:bg-gray-50 hover:border-gray-300 transition-all">
                                    <svg class="w-3 h-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- Remove Button -->
                            <button onclick="removeFromCart('{{ item.id }}')" 
                                    class="w-8 h-8 rounded-full flex items-center justify-center text-gray-400 hover:bg-red-50 hover:text-red-500 transition-all">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Order Summary -->
        <div class="mt-12 max-w-md mx-auto lg:max-w-none lg:mt-8">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-6">
                    <h2 class="text-xl font-medium text-gray-900 mb-6">Order Summary</h2>
                    
                    <!-- Itemized List -->
                    <div class="space-y-3 mb-6 max-h-64 overflow-y-auto">
                        {% for item in cart_items %}
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <div class="flex-1">
                                <h4 class="text-sm font-medium text-gray-900 line-clamp-1">{{ item.name }}</h4>
                                <p class="text-xs text-gray-500">{{ item.quantity }} Ã— {{ item.price | currency_format }}</p>
                            </div>
                            <span>{{ (item.price * item.quantity) | currency_format }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="space-y-4 mb-6">
                        <div class="flex justify-between text-gray-600">
                            <span class="font-medium">Subtotal</span>
                            <span class="font-medium">{{ subtotal | currency_format }}</span>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-100 pt-6 mb-6">
                        <div class="flex justify-between text-lg font-semibold text-gray-900">
                            <span>Total</span>
                            <span>{{ subtotal | currency_format }}</span>
                        </div>
                    </div>
                        
                        <div class="space-y-3">
                            <a href="{{ url_for('checkout') }}" 
                               class="block w-full bg-gradient-to-r from-amber-500 to-amber-600 text-white text-center py-4 px-6 rounded-2xl hover:from-amber-600 hover:to-amber-700 transition-all duration-300 font-medium shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                Proceed to Checkout
                            </a>
                            <button onclick="clearCart()" 
                                    class="block w-full border border-gray-200 text-gray-700 py-3 px-4 rounded-2xl hover:bg-gray-50 transition-all duration-300 font-medium">
                                Clear Cart
                            </button>
                            <a href="{{ url_for('home') }}" 
                               class="block w-full text-center text-amber-600 hover:text-amber-700 py-2 font-medium transition-colors">
                                Continue Shopping
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="text-center py-16">
            <div class="w-32 h-32 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-16 h-16 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/>
                </svg>
            </div>
            <h3 class="text-2xl font-light text-gray-600 mb-3">Your cart is empty</h3>
            <p class="text-gray-500 mb-8 max-w-md mx-auto">Looks like you haven't added any products to your cart yet.</p>
            <a href="{{ url_for('home') }}" 
               class="bg-gradient-to-r from-amber-500 to-amber-600 text-white px-8 py-3 rounded-2xl hover:from-amber-600 hover:to-amber-700 transition-all duration-300 font-medium shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                Start Shopping
            </a>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
function formatCurrency(price) {
    return new Intl.NumberFormat('en-KE', {
        style: 'currency',
        currency: 'KES',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(price);
}

function updateQuantity(productId, newQuantity) {
    if (newQuantity <= 0) {
        removeFromCart(productId);
    } else {
        fetch('/update_quantity', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                product_id: productId,
                quantity: newQuantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateCartDisplay(data.cart_count, data.cart_total);
                location.reload();
            } else {
                showNotification('Error updating quantity', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error updating quantity', 'error');
        });
    }
}

function removeFromCart(productId) {
    if (confirm('Are you sure you want to remove this item from your cart?')) {
        fetch('/remove_from_cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                product_id: productId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateCartDisplay(data.cart_count, data.cart_total);
                location.reload();
            } else {
                showNotification('Error removing item from cart', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error removing item from cart', 'error');
        });
    }
}

function clearCart() {
    if (confirm('Are you sure you want to clear your entire cart?')) {
        fetch('/clear_cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateCartDisplay(0, 0);
                location.reload();
            } else {
                showNotification('Error clearing cart', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error clearing cart', 'error');
        });
    }
}

function updateCartDisplay(cartCount, cartTotal) {
    // Update cart button count if it exists
    const cartButton = document.getElementById('cart-count');
    if (cartButton) {
        cartButton.textContent = cartCount;
    }
    
    // Update cart total on page
    const totalElements = document.querySelectorAll('.cart-total');
    totalElements.forEach(element => {
        element.textContent = `Kshs. ${formatCurrency(cartTotal)}`;
    });
    
    // Update cart count on page
    const countElements = document.querySelectorAll('.cart-count');
    countElements.forEach(element => {
        element.textContent = cartCount;
    });
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all transform translate-x-full ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Slide in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// Initialize cart display on page load
document.addEventListener('DOMContentLoaded', function() {
    // Fetch current cart data
    fetch('/get_cart_count')
        .then(response => response.json())
        .then(data => {
            updateCartDisplay(data.count, data.total);
        })
        .catch(error => {
            console.error('Error fetching cart data:', error);
        });
});
</script>
{% endblock %}
